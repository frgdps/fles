<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>List2Do++ | Aplikasi To-Do List Fless</title>
    <meta name="theme-color" content="#4361ee">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        /* ---------- THEME TOKENS (minimal & stable) ---------- */
        :root{
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --success: #2ecc71;
            --danger: #e74c3c;
            --muted: #95a5a6;
            --bg-grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            --card-bg: #ffffff;
            --radius: 14px;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --transition: 180ms ease;
        }
        [data-theme="dark"]{
            --primary: #9fb4ff;
            --primary-dark: #3a0ca3;
            --success: #22c55e;
            --danger: #ef6b6b;
            --muted: #a6b0c3;
            --bg-grad: linear-gradient(135deg,#0f172a 0%,#111827 100%);
            --card-bg: #1f2937;
            --shadow: 0 6px 22px rgba(0,0,0,0.45);
            color-scheme: dark;
        }

        /* ---------- BASE ---------- */
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial;background:var(--bg-grad);-webkit-font-smoothing:antialiased}
        .container{max-width:560px;margin:0 auto;padding-bottom:120px}
        .mobile-header{display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--primary);color:#fff;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
        .logo{font-weight:700;display:flex;align-items:center;gap:10px}

        /* add-section */
        .add-section{display:flex;gap:8px;background:var(--card-bg);padding:10px;border-radius:10px;box-shadow:var(--shadow);margin:14px}
        .add-section input{flex:1;padding:10px;border-radius:8px;border:1px solid #eee}
        .btn{background:var(--primary);color:#fff;padding:9px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}

        /* stats */
        .stats{display:flex;gap:12px;overflow:auto;padding:10px 14px}
        .stat-card{min-width:110px;background:var(--card-bg);padding:12px;border-radius:10px;box-shadow:var(--shadow);text-align:center}
        .stat-value{font-weight:700;color:var(--primary-dark);font-size:1.1rem}
        .stat-label{font-size:.82rem;color:var(--muted)}

        /* categories slider */
        .categories-slider{display:flex;gap:16px;padding:6px 14px;overflow:auto;scroll-snap-type:x mandatory}
        .category-card{min-width:92vw;max-width:520px;background:var(--card-bg);border-radius:12px;padding:8px;box-shadow:var(--shadow);scroll-snap-align:center;position:relative}
        @media(min-width:600px){ .category-card{min-width:420px} }
        .category-header{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
        .category-title{display:flex;gap:8px;align-items:center;font-weight:700}

        /* progress bar under header */
        .progress-wrap{height:8px;background:rgba(255,255,255,0.15);border-radius:6px;margin-top:8px;overflow:hidden}
        .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,rgba(255,255,255,0.9),rgba(255,255,255,0.6));transition:width var(--transition)}

        .tasks-container{padding:10px}
        .task{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;margin-bottom:8px;background:var(--card-bg);box-shadow:0 2px 8px rgba(0,0,0,0.04)}
        .task.done{opacity:.6;text-decoration:line-through}
        .task-checkbox{width:18px;height:18px;accent-color:var(--success)}
        .task-content{flex:1;min-width:0}
        .task-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .task-meta{font-size:.82rem;color:var(--muted)}

        .task-actions{display:flex;gap:6px;align-items:center}
        .task-action-btn{background:none;border:none;cursor:pointer;color:var(--muted);padding:6px;border-radius:8px}
        .task-action-btn:hover{color:var(--primary-dark);background:rgba(0,0,0,0.03)}

        .add-task-btn{display:block;width:100%;margin-top:8px;padding:9px;border-radius:8px;border:2px dashed var(--primary);background:rgba(67,97,238,0.04);cursor:pointer;text-align:center}

        /* quick-add inline */
        .quick-add-row{display:flex;gap:8px;margin-top:8px;align-items:center}
        .quick-add-row input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
        .quick-add-row input[type="date"]{padding:8px;border-radius:8px;border:1px solid #ddd}
        .quick-add-row .small-btn{padding:8px 10px;border-radius:8px;background:var(--primary);color:#fff;border:none;cursor:pointer}

        /* slider dots */
        .slider-dots{display:flex;justify-content:center;gap:8px;padding:6px}
        .slider-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);opacity:.4}
        .slider-dot.active{background:var(--primary);opacity:1;transform:scale(1.2)}

        /* bottom nav */
        .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--card-bg);display:flex;gap:8px;justify-content:space-around;padding:8px;border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -6px 20px rgba(0,0,0,0.06)}
        .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--muted);text-decoration:none;padding:4px;border-radius:8px}
        .nav-item.active{color:var(--primary);background:rgba(67,97,238,0.06)}

        /* modal (settings) */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;z-index:9999}
        .modal{background:var(--card-bg);padding:16px;border-radius:12px;box-shadow:var(--shadow);max-width:92vw}
        .hidden{display:none}

        /* snackbar / undo */
        .snackbar{position:fixed;left:50%;transform:translateX(-50%);bottom:84px;background:var(--card-bg);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:center;z-index:200}
        .snackbar button{background:transparent;border:1px solid var(--primary);padding:6px 10px;border-radius:8px;color:var(--primary);cursor:pointer}

        /* heatmap simple (stat modal) */
        .heatmap{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:12px}
        .heatmap .cell{width:18px;height:18px;border-radius:4px;background:#eee}
        .heat-0{background:#f0f0f0}
        .heat-1{background:#c6f6d5}
        .heat-2{background:#7ee787}
        .heat-3{background:#2f9e52}
        .heat-4{background:#176b3b}

        /* utils */
        .hidden-clip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
        @media (min-width:600px){ .container{padding:18px} }
    </style>
</head>
<body>
    <div class="container">
        <header class="mobile-header">
            <div class="logo"><i class="fas fa-tasks"></i> List2Do++</div>
            <div class="mobile-actions">
                <button id="statsBtn" title="Statistik"><i class="fas fa-chart-pie"></i></button>
                <button id="settingsBtn" title="Pengaturan"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card"><i class="fas fa-clipboard-list"></i><div class="stat-value" id="pendingTasks">0</div><div class="stat-label">Belum Selesai</div></div>
            <div class="stat-card"><i class="fas fa-layer-group"></i><div class="stat-value" id="totalCategories">0</div><div class="stat-label">Kategori</div></div>
            <div class="stat-card"><i class="fas fa-list-check"></i><div class="stat-value" id="totalTasks">0</div><div class="stat-label">Total Tugas</div></div>
        </div>

        <div class="add-section">
            <input id="newCategory" placeholder="Nama kategori baru..." maxlength="24" aria-label="Nama kategori">
            <button id="addCategoryBtn" class="btn"><i class="fas fa-plus"></i> Kategori</button>
        </div>

        <div id="categoriesSlider" class="categories-slider"></div>
        <div id="sliderDots" class="slider-dots"></div>

        <div class="bottom-nav">
            <a href="#" class="nav-item active"><i class="fas fa-home"></i><span>Beranda</span></a>
            <a href="#" class="nav-item" id="btnTemplates"><i class="fas fa-copy"></i><span>Template</span></a>
            <a href="#" class="nav-item" id="btnAddQuick"><i class="fas fa-plus-circle"></i><span>Tambah</span></a>
        </div>
    </div>

    <!-- Settings modal -->
    <div id="settingsModal" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal">
            <button class="modal-close" id="closeSettings"><i class="fas fa-times"></i></button>
            <h2>Pengaturan</h2>
            <div class="setting-group">
                <label>Tema</label>
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="theme-btn" data-theme="light">Terang</button>
                    <button class="theme-btn" data-theme="dark">Gelap</button>
                </div>
            </div>
            <div class="setting-group">
                <label>Aksen</label>
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button class="accent-btn" data-accent="blue" style="background:#4361ee;width:28px;height:28px;border-radius:6px;border:0"></button>
                    <button class="accent-btn" data-accent="green" style="background:#22c55e;width:28px;height:28px;border-radius:6px;border:0"></button>
                    <button class="accent-btn" data-accent="pink" style="background:#ee4f8a;width:28px;height:28px;border-radius:6px;border:0"></button>
                </div>
            </div>
            <div style="margin-top:12px">
                <button class="btn" id="resetBtn">Reset Semua Data</button>
            </div>
        </div>
    </div>

    <!-- Stats modal with heatmap -->
    <div id="statsModal" class="modal-overlay hidden" aria-hidden="true">
      <div class="modal">
        <button class="modal-close" id="closeStats"><i class="fas fa-times"></i></button>
        <h2>Statistik Produktivitas</h2>
        <pre id="statsText" style="white-space:pre-wrap;background:transparent;border:none;padding:0;margin:0;color:var(--muted)"></pre>
        <div id="heatmap" class="heatmap"></div>
      </div>
    </div>

    <!-- snackbar (undo) -->
    <div id="snackbar" class="snackbar" style="display:none"></div>

    <div class="hidden-clip" aria-hidden="true">List2Do++</div>

<script>
/* =========================
   Data & helpers
   ========================= */
const STORAGE_KEY = 'list2do_data';
let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || [];
// undo stack {type:'task'|'category', payload:{...}, idx:..., expireTimer}
let undoStack = [];

/* Debounced save to reduce localStorage churn */
function debounce(fn, wait=120){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,a), wait); }; }
const _saveImmediate = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); renderCategories(); calculateStats(); };
const saveData = debounce(_saveImmediate, 120);

/* small uid */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

/* =========================
   UI helpers: snackbar undo
   ========================= */
const snackbarEl = document.getElementById('snackbar');
function showSnackbar(message, undoHandler){
  snackbarEl.innerHTML = '';
  const msg = document.createElement('div'); msg.textContent = message;
  const btn = document.createElement('button'); btn.textContent = 'Undo';
  snackbarEl.appendChild(msg);
  snackbarEl.appendChild(btn);
  snackbarEl.style.display = 'flex';
  const clearFn = ()=> { snackbarEl.style.display='none'; snackbarEl.innerHTML=''; };
  const timer = setTimeout(()=> { clearFn(); }, 7000);
  btn.onclick = ()=> { clearTimeout(timer); clearFn(); undoHandler(); };
}

/* =========================
   Settings (theme & accent)
   ========================= */
function applySettings(){
  const theme = localStorage.getItem('list2do_theme') || 'light';
  document.documentElement.setAttribute('data-theme', theme);
  const accent = localStorage.getItem('list2do_accent') || 'blue';
  document.documentElement.setAttribute('data-accent', accent);
}
document.getElementById('settingsBtn').addEventListener('click', ()=> {
  document.getElementById('settingsModal').classList.remove('hidden');
  document.getElementById('settingsModal').setAttribute('aria-hidden', 'false');
});
document.getElementById('closeSettings').addEventListener('click', ()=> {
  document.getElementById('settingsModal').classList.add('hidden');
  document.getElementById('settingsModal').setAttribute('aria-hidden', 'true');
});
document.querySelectorAll('.theme-btn').forEach(b=> b.onclick = ()=> { localStorage.setItem('list2do_theme', b.dataset.theme); applySettings(); });
document.querySelectorAll('.accent-btn').forEach(b=> b.onclick = ()=> { localStorage.setItem('list2do_accent', b.dataset.accent); applySettings(); });
document.getElementById('resetBtn').addEventListener('click', ()=> {
  if (confirm('Hapus semua data?')) { localStorage.removeItem(STORAGE_KEY); data = []; saveData(); renderCategories(); }
});
applySettings();

/* =========================
   Core: stats and render
   ========================= */
function calculateStats(){
  const totalCategories = data.length;
  let totalTasks=0, pending=0;
  data.forEach(c=>{ totalTasks += c.tasks.length; pending += c.tasks.filter(t=>!t.done).length; });
  document.getElementById('totalCategories').textContent = totalCategories;
  document.getElementById('totalTasks').textContent = totalTasks;
  document.getElementById('pendingTasks').textContent = pending;
}

/* Render categories & tasks */
const categoriesSlider = document.getElementById('categoriesSlider');
const sliderDots = document.getElementById('sliderDots');
let sliderCurrent = 0;

function renderCategories(){
  if (!data || data.length === 0) {
    categoriesSlider.innerHTML = `<div class="empty-state"><i class="fas fa-clipboard-list"></i><div>Belum ada kategori. Tambah kategori baru untuk memulai.</div></div>`;
    sliderDots.innerHTML = '';
    calculateStats();
    return;
  }

  categoriesSlider.innerHTML = data.map((category, catIndex) => {
    // progress
    const done = category.tasks.filter(t=>t.done).length;
    const total = category.tasks.length || 1;
    const percent = Math.round((done/total)*100);

    // tasks HTML
    const tasksHtml = category.tasks.length ? category.tasks.map((task, taskIndex) => {
      const doneCls = task.done ? 'done' : '';
      const dueText = task.due ? `<div class="task-meta">Due: ${task.due}</div>` : '';
      return `
        <div class="task ${doneCls}" data-cat="${catIndex}" data-task="${taskIndex}">
            <i class="fas fa-grip-vertical task-handle" title="Seret untuk urut (opsional)"></i>
            <input type="checkbox" class="task-checkbox" ${task.done? 'checked' : ''} onclick="toggleTask(${catIndex}, ${taskIndex})">
            <div class="task-content">
                <div class="task-name">${escapeHtml(task.name)}</div>
                ${dueText}
            </div>
            <div class="task-actions">
                <button class="task-action-btn" title="Pindah atas" onclick="moveTask(${catIndex}, ${taskIndex}, 'up')"><i class="fas fa-arrow-up"></i></button>
                <button class="task-action-btn" title="Pindah bawah" onclick="moveTask(${catIndex}, ${taskIndex}, 'down')"><i class="fas fa-arrow-down"></i></button>
                <button class="task-action-btn" title="Edit" onclick="openEditTask(${catIndex}, ${taskIndex})"><i class="fas fa-edit"></i></button>
                <button class="task-action-btn" title="Hapus" onclick="deleteTaskWithUndo(${catIndex}, ${taskIndex})"><i class="fas fa-trash"></i></button>
            </div>
        </div>
      `;
    }).join('') : `<div class="empty-state" style="padding:14px 0"><i class="fas fa-tasks"></i><div>Belum ada tugas.</div></div>`;

    // quick-add row element id's
    const quickIdText = `quick-input-${catIndex}`;
    const quickIdDate = `quick-date-${catIndex}`;

    return `
      <div class="category-card" data-cat="${catIndex}">
          <div class="category-header">
            <div>
              <div class="category-title"><i class="fas fa-folder"></i> ${escapeHtml(category.name)}</div>
              <div style="font-size:.82rem;opacity:.9;margin-top:6px">${done}/${category.tasks.length || 0} selesai</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <div style="width:80px">
                <div class="progress-wrap" aria-hidden="true"><div class="progress-bar" style="width:${percent}%"></div></div>
              </div>
              <div class="category-actions">
                  <button title="Hapus kategori" onclick="deleteCategoryWithUndo(${catIndex})"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>

          <div class="tasks-container" id="tasks-${catIndex}">
            ${tasksHtml}
            <!-- quick add inline -->
            <div class="quick-add-row">
              <input id="${quickIdText}" type="text" placeholder="Tambah tugas... (Enter untuk simpan)" onkeydown="if(event.key==='Enter') quickAdd(${catIndex})">
              <input id="${quickIdDate}" type="date">
              <button class="small-btn" onclick="quickAdd(${catIndex})">Tambah</button>
            </div>

            <button class="add-task-btn" onclick="focusQuick(${catIndex})"><i class="fas fa-plus"></i> Tambah Tugas</button>
          </div>
      </div>
    `;
  }).join('');

  // dots
  sliderDots.innerHTML = data.map((_,i)=>`<div class="slider-dot ${i===sliderCurrent? 'active':''}" data-dot="${i}"></div>`).join('');

  calculateStats();
  initSortable(); // re-init Sortable for drag if present
  setupSliderNavOnce();
}

/* escape */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* =========================
   CRUD with undo
   ========================= */
function addCategory(){
  const input = document.getElementById('newCategory');
  const name = input.value.trim();
  if (!name) { alert('Nama kategori tidak boleh kosong'); return; }
  data.push({ id: uid(), name, tasks: [] });
  input.value = '';
  saveData();
  renderCategories();
  setTimeout(()=> scrollToCategory(data.length-1), 80);
}

function deleteCategoryWithUndo(catIndex){
  const removed = data.splice(catIndex, 1)[0];
  saveData();
  renderCategories();
  // push undo
  const idx = catIndex;
  showSnackbar(`Kategori "${removed.name}" dihapus`, ()=> {
    data.splice(idx, 0, removed);
    saveData();
    renderCategories();
  });
}

function quickAdd(catIndex){
  const textEl = document.getElementById(`quick-input-${catIndex}`);
  const dateEl = document.getElementById(`quick-date-${catIndex}`);
  if (!textEl) return;
  const name = (textEl.value || '').trim();
  const due = dateEl ? (dateEl.value || null) : null;
  if (!name) { textEl.focus(); return; }
  const t = { id: uid(), name: name.substring(0,180), done:false, createdAt: new Date().toISOString().split('T')[0], due: due };
  data[catIndex].tasks.push(t);
  textEl.value = ''; if (dateEl) dateEl.value = '';
  saveData();
  renderCategories();
  setTimeout(()=> scrollToCategory(catIndex), 40);
}

function focusQuick(catIndex){
  const txt = document.getElementById(`quick-input-${catIndex}`);
  if (txt) txt.focus();
}

function openEditTask(catIndex, taskIndex){
  const cur = data[catIndex].tasks[taskIndex];
  const newName = prompt('Edit nama tugas:', cur.name);
  if (newName === null) return;
  cur.name = newName.trim().substring(0,180);
  saveData();
  renderCategories();
}

/* delete task with undo */
function deleteTaskWithUndo(catIndex, taskIndex){
  const removed = data[catIndex].tasks.splice(taskIndex,1)[0];
  const catName = data[catIndex] ? data[catIndex].name : '(kategori)';
  saveData();
  renderCategories();
  const idx = taskIndex;
  showSnackbar(`Tugas "${removed.name}" dihapus`, ()=> {
    data[catIndex].tasks.splice(idx, 0, removed);
    saveData();
    renderCategories();
  });
}

/* toggle done */
function toggleTask(catIndex, taskIndex){
  data[catIndex].tasks[taskIndex].done = !data[catIndex].tasks[taskIndex].done;
  // if completed today, add to history for heatmap
  if (data[catIndex].tasks[taskIndex].done){
    const today = new Date().toISOString().split('T')[0];
    data.meta = data.meta || { history: {} };
    data.meta.history = data.meta.history || {};
    data.meta.history[today] = (data.meta.history[today] || 0) + 1;
  }
  saveData();
  renderCategories();
}

/* move task up/down */
function moveTask(catIndex, taskIndex, dir){
  const tasks = data[catIndex].tasks;
  const i = taskIndex, j = dir === 'up' ? i-1 : i+1;
  if (j<0 || j>=tasks.length) return;
  [tasks[i], tasks[j]] = [tasks[j], tasks[i]];
  saveData();
  renderCategories();
}

/* =========================
   Sorting (kept simple)
   ========================= */
function sortTasks(catIndex, sortBy){
  switch(sortBy){
    case 'name': data[catIndex].tasks.sort((a,b)=> a.name.localeCompare(b.name)); break;
    case 'date': data[catIndex].tasks.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt)); break;
    case 'completed': data[catIndex].tasks.sort((a,b)=> a.done - b.done); break;
  }
  saveData(); renderCategories();
}

/* =========================
   Slider navigation & init Sortable
   ========================= */
function renderSliderDots(active){
  sliderDots.innerHTML = data.map((_,i)=>`<div class="slider-dot ${i===active? 'active':''}" data-dot="${i}"></div>`).join('');
}
function scrollToCategory(idx){
  const slider = document.getElementById('categoriesSlider');
  if (slider && slider.children[idx]) slider.children[idx].scrollIntoView({behavior:'smooth', inline:'center'});
}

/* slider nav + click dots */
let sliderNavInit = false;
function setupSliderNavOnce(){
  if (sliderNavInit) return;
  const slider = document.getElementById('categoriesSlider');
  slider.addEventListener('scroll', () => {
    if (!slider.children.length) return;
    let minDist = Infinity, idx = 0;
    for (let i=0;i<slider.children.length;i++){
      const rect = slider.children[i].getBoundingClientRect();
      const dist = Math.abs(rect.left + rect.width/2 - window.innerWidth/2);
      if (dist < minDist){ minDist = dist; idx = i; }
    }
    if (sliderCurrent !== idx){
      sliderCurrent = idx; renderSliderDots(idx);
    }
  });
  sliderDots.addEventListener('click', (e)=>{
    if (e.target.classList.contains('slider-dot')) scrollToCategory(Number(e.target.dataset.dot));
  });
  sliderNavInit = true;
}

/* init Sortable (optional) */
function initSortable(){
  data.forEach((cat, catIndex) => {
    const container = document.getElementById('tasks-'+catIndex);
    if (!container) return;
    if (container._sortable) container._sortable.destroy();
    container._sortable = new Sortable(container, {
      group: 'tasks', handle: '.task-handle', draggable: '.task', animation: 160,
      onEnd(evt){
        if (evt.oldIndex === evt.newIndex) return;
        const moved = data[catIndex].tasks.splice(evt.oldIndex, 1)[0];
        data[catIndex].tasks.splice(evt.newIndex, 0, moved);
        saveData(); renderCategories();
      }
    });
  });
}

/* =========================
   Heatmap & Stats modal
   ========================= */
const statsBtn = document.getElementById('statsBtn');
const statsModal = document.getElementById('statsModal');
const closeStats = document.getElementById('closeStats');
const statsText = document.getElementById('statsText');
const heatmapEl = document.getElementById('heatmap');

statsBtn.addEventListener('click', ()=> {
  const history = (data.meta && data.meta.history) ? data.meta.history : {};
  let text = `Kategori: ${data.length}\nTotal tugas: ${data.reduce((s,c)=>s+c.tasks.length,0)}\nBelum selesai: ${data.reduce((s,c)=>s+c.tasks.filter(t=>!t.done).length,0)}\n\nKontribusi harian (terakhir):\n`;
  const keys = Object.keys(history).sort().slice(-14);
  keys.forEach(k => text += `${k}: ${history[k]} selesai\n`);
  statsText.textContent = text;
  renderHeatmap(history);
  statsModal.classList.remove('hidden');
});
closeStats.addEventListener('click', ()=> statsModal.classList.add('hidden'));

function renderHeatmap(history){
  heatmapEl.innerHTML = '';
  const days = 70; // ~10 minggu
  for (let i=days-1;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const key = d.toISOString().split('T')[0];
    const val = history[key] || 0;
    const level = val>=5?4:val>=3?3:val>=1?2:0;
    const div = document.createElement('div'); div.className = `cell heat-${level}`; div.title = `${key}: ${val}`;
    heatmapEl.appendChild(div);
  }
}

/* =========================
   Quick templates
   ========================= */
document.getElementById('btnTemplates').addEventListener('click', ()=> {
  const tpl = prompt('Pilih template: 1=Belanja, 2=Perjalanan, 3=Belajar\nKetik angka:');
  if (!tpl) return;
  const name = tpl==='1'? 'Belanja' : tpl==='2'? 'Perjalanan' : 'Belajar';
  const items = tpl==='1'? ['Beras','Telur','Susu','Gula'] : tpl==='2'? ['Packing','Tiket','Hotel','Checklist kendaraan'] : ['Baca modul','Latihan soal','Istirahat'];
  data.push({ id: uid(), name, tasks: items.map(it=>({ id: uid(), name: it, done:false, createdAt: new Date().toISOString().split('T')[0] })) });
  saveData(); renderCategories(); setTimeout(()=> scrollToCategory(data.length-1), 60);
});

/* =========================
   Keyboard shortcuts
   ========================= */
document.addEventListener('keydown', (e) => {
  const active = document.activeElement;
  if (active && (active.tagName==='INPUT' || active.tagName==='TEXTAREA')) return; // avoid typing conflicts
  if (e.key === '/') { e.preventDefault(); const s = document.getElementById('searchInput'); if (s) s.focus(); }
  if (e.key === 'n') { document.getElementById('newCategory').focus(); }
  if (e.key === 't') { // open quick on current slider index
    const idx = sliderCurrent || 0;
    const q = document.getElementById(`quick-input-${idx}`);
    if (q) q.focus();
  }
});

/* =========================
   Notifications & reminders
   ========================= */
async function ensureNotifications(){
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') return true;
  if (Notification.permission !== 'denied') {
    const p = await Notification.requestPermission();
    return p === 'granted';
  }
  return false;
}

async function checkReminders(){
  if (!await ensureNotifications()) return;
  const today = new Date().toISOString().split('T')[0];
  data.forEach((cat)=> {
    cat.tasks.forEach((t)=> {
      if (t.due && !t.done && t.due === today){
        try {
          new Notification('Tugas jatuh tempo: ' + t.name);
        } catch(e) { console.warn('notif failed', e); }
      }
    });
  });
}

/* visibility change */
document.addEventListener('visibilitychange', ()=> { if (document.visibilityState === 'visible') checkReminders(); });

/* =========================
   Utility init & expose
   ========================= */
function init(){
  renderCategories();
  calculateStats();
  setupSliderNavOnce();
  if (data.length) setTimeout(()=> scrollToCategory(0), 80);
  // search input (minimal)
  const searchInput = document.createElement('input');
  searchInput.id = 'searchInput';
  searchInput.placeholder = 'Cari tugas, tag... (tekan / untuk fokus)';
  searchInput.style.width = 'calc(100% - 28px)';
  searchInput.style.margin = '12px 14px';
  searchInput.addEventListener('input', debounce(()=> renderCategories(), 160));
  document.querySelector('.container').insertBefore(searchInput, document.querySelector('.stats'));
  // check reminders on load
  checkReminders();
}
init();

/* expose functions for inline onclick usage */
window.addCategory = addCategory;
document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
window.deleteCategoryWithUndo = deleteCategoryWithUndo;
window.deleteTaskWithUndo = deleteTaskWithUndo;
window.toggleTask = toggleTask;
window.openEditTask = openEditTask;
window.moveTask = moveTask;
window.quickAdd = quickAdd;
window.sortTasks = sortTasks;
window.focusQuick = focusQuick;
</script>
</body>
</html>