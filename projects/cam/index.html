<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV Test Studio Pro - Professional Audio-Visual Testing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --dark: #1d3557;
            --darker: #14213d;
            --light: #f8f9fa;
            --gray: #6c757d;
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.15);
            --text: #f8f9fa;
            --text-secondary: rgba(248, 249, 250, 0.8);
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--success), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .panel h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            color: var(--success);
        }

        .video-container, .visualizer-container {
            position: relative;
            width: 100%;
            height: 350px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--card-border);
        }

        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .placeholder {
            color: var(--text-secondary);
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
        }

        .video-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 8px;
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: var(--warning);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(247, 37, 133, 0); }
            100% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0); }
        }

        #visualizer {
            width: 100%;
            height: 100%;
            display: none;
        }

        .waveform-container {
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.25);
            color: white;
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-height: 70px;
        }

        .btn i {
            font-size: 1.4rem;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .btn.active {
            background: rgba(76, 201, 240, 0.3);
            border-color: var(--success);
            color: white;
        }

        .btn.danger {
            background: rgba(247, 37, 133, 0.2);
            border-color: var(--warning);
        }

        .btn.recording {
            background: rgba(247, 37, 133, 0.3);
            border-color: var(--warning);
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(247, 37, 133, 0); }
            100% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0); }
        }

        .settings-group {
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
        }

        .settings-group h3 {
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: var(--success);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }

        .slider-label {
            min-width: 120px;
            font-size: 0.95rem;
        }

        .slider {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .value-display {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: var(--success);
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-panel h3 {
            margin-bottom: 15px;
            color: var(--success);
            font-size: 1.3rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .info-label {
            display: block;
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-value {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-top: 25px;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .device-selector {
            margin-bottom: 20px;
        }

        .device-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .device-selector select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .device-selector select:focus {
            border-color: var(--primary);
        }

        .device-selector select option {
            background: var(--darker);
        }

        .test-results {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .test-results h3 {
            margin-bottom: 15px;
            color: var(--success);
            font-size: 1.3rem;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .status-icon.success {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        .status-icon.error {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
        }

        .status-icon.warning {
            background: #ff9800;
            box-shadow: 0 0 10px #ff9800;
        }

        .status-icon.pending {
            background: #9e9e9e;
        }

        .diagnostics-panel {
            grid-column: 1 / -1;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--card-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .diagnostics-panel h2 {
            margin-bottom: 20px;
            color: var(--success);
        }

        .diagnostics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .diagnostic-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .diagnostic-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--success);
        }

        .diagnostic-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--text);
        }

        .diagnostic-label {
            opacity: 0.8;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .recording-timer {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: var(--warning);
            display: none;
        }

        .recording-timer.active {
            display: block;
        }

        @media (max-width: 992px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .diagnostics-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .diagnostics-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .btn {
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-video"></i> AV Test Studio Pro</h1>
            <p>Professional Audio-Visual Testing & Diagnostics Tool</p>
        </div>

        <div class="main-grid">
            <!-- Camera Panel -->
            <div class="panel">
                <h2><i class="fas fa-camera"></i> Camera Preview</h2>
                
                <div class="video-container">
                    <video id="webcam" autoplay muted playsinline></video>
                    <div class="placeholder" id="cameraPlaceholder">
                        <i class="fas fa-video-slash fa-3x"></i>
                        <p>Camera not active</p>
                    </div>
                    <div class="video-overlay">
                        <div class="recording-indicator" id="recordingIndicator">
                            <div class="recording-dot"></div>
                            <span>LIVE</span>
                        </div>
                    </div>
                </div>

                <div class="device-selector">
                    <label><i class="fas fa-camera"></i> Camera Device:</label>
                    <select id="cameraSelect">
                        <option value="">Select Camera...</option>
                    </select>
                </div>

                <div class="controls">
                    <button class="btn" id="startCamera">
                        <i class="fas fa-play"></i>
                        <span>Start Camera</span>
                    </button>
                    <button class="btn danger" id="stopCamera">
                        <i class="fas fa-stop"></i>
                        <span>Stop Camera</span>
                    </button>
                    <button class="btn" id="switchCamera">
                        <i class="fas fa-sync-alt"></i>
                        <span>Switch Camera</span>
                    </button>
                    <button class="btn" id="takeSnapshot">
                        <i class="fas fa-camera"></i>
                        <span>Snapshot</span>
                    </button>
                    <button class="btn" id="startRecording">
                        <i class="fas fa-circle"></i>
                        <span>Record</span>
                    </button>
                    <button class="btn" id="stopRecording">
                        <i class="fas fa-stop-circle"></i>
                        <span>Stop Recording</span>
                    </button>
                </div>

                <div class="settings-group">
                    <h3><i class="fas fa-sliders-h"></i> Video Settings</h3>
                    <div class="slider-container">
                        <span class="slider-label">Quality:</span>
                        <input type="range" id="qualitySlider" class="slider" min="0" max="100" value="80">
                        <span class="value-display" id="qualityValue">80%</span>
                    </div>
                    <div class="slider-container">
                        <span class="slider-label">Zoom:</span>
                        <input type="range" id="zoomSlider" class="slider" min="100" max="200" value="100">
                        <span class="value-display" id="zoomValue">100%</span>
                    </div>
                </div>

                <div class="info-panel">
                    <h3><i class="fas fa-info-circle"></i> Camera Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Resolution</span>
                            <span class="info-value" id="resolution">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">FPS</span>
                            <span class="info-value" id="fps">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status</span>
                            <span class="info-value" id="cameraStatus">Inactive</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Device</span>
                            <span class="info-value" id="cameraDevice">-</span>
                        </div>
                    </div>
                </div>

                <div class="test-results">
                    <h3><i class="fas fa-vial"></i> Camera Test Results</h3>
                    <div class="test-item">
                        <span>Camera Access</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="cameraAccessStatus"></div>
                            <span id="cameraAccessText">Not Tested</span>
                        </div>
                    </div>
                    <div class="test-item">
                        <span>Video Stream</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="videoStreamStatus"></div>
                            <span id="videoStreamText">Not Tested</span>
                        </div>
                    </div>
                    <div class="test-item">
                        <span>Frame Rate</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="frameRateStatus"></div>
                            <span id="frameRateText">Not Tested</span>
                        </div>
                    </div>
                    <div class="test-item">
                        <span>Resolution Test</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="resolutionStatus"></div>
                            <span id="resolutionText">Not Tested</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio Panel -->
            <div class="panel">
                <h2><i class="fas fa-microphone"></i> Audio Preview & Visualizer</h2>
                
                <div class="visualizer-container">
                    <canvas id="visualizer"></canvas>
                    <div class="waveform-container" id="waveformContainer"></div>
                    <div class="placeholder" id="audioPlaceholder">
                        <i class="fas fa-microphone-slash fa-3x"></i>
                        <p>Microphone not active</p>
                    </div>
                </div>

                <div class="device-selector">
                    <label><i class="fas fa-microphone"></i> Microphone Device:</label>
                    <select id="micSelect">
                        <option value="">Select Microphone...</option>
                    </select>
                </div>

                <div class="controls">
                    <button class="btn" id="startMic">
                        <i class="fas fa-microphone"></i>
                        <span>Start Mic</span>
                    </button>
                    <button class="btn danger" id="stopMic">
                        <i class="fas fa-microphone-slash"></i>
                        <span>Stop Mic</span>
                    </button>
                    <button class="btn" id="toggleEcho">
                        <i class="fas fa-volume-up"></i>
                        <span>Echo: OFF</span>
                    </button>
                    <button class="btn" id="testTone">
                        <i class="fas fa-music"></i>
                        <span>Test Tone</span>
                    </button>
                    <button class="btn" id="toggleVisualizer">
                        <i class="fas fa-wave-square"></i>
                        <span>Waveform</span>
                    </button>
                    <button class="btn" id="noiseReduction">
                        <i class="fas fa-volume-mute"></i>
                        <span>Noise Reduction</span>
                    </button>
                </div>

                <div class="settings-group">
                    <h3><i class="fas fa-sliders-h"></i> Audio Settings</h3>
                    <div class="slider-container">
                        <span class="slider-label">Mic Volume:</span>
                        <input type="range" id="micVolumeSlider" class="slider" min="0" max="100" value="50">
                        <span class="value-display" id="micVolumeValue">50%</span>
                    </div>
                    <div class="slider-container">
                        <span class="slider-label">Echo Volume:</span>
                        <input type="range" id="echoVolumeSlider" class="slider" min="0" max="100" value="30">
                        <span class="value-display" id="echoVolumeValue">30%</span>
                    </div>
                    <div class="slider-container">
                        <span class="slider-label">Sensitivity:</span>
                        <input type="range" id="sensitivitySlider" class="slider" min="0" max="100" value="70">
                        <span class="value-display" id="sensitivityValue">70%</span>
                    </div>
                </div>

                <div class="info-panel">
                    <h3><i class="fas fa-info-circle"></i> Audio Information</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Input Level</span>
                            <span class="info-value" id="inputLevel">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Frequency</span>
                            <span class="info-value" id="frequency">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status</span>
                            <span class="info-value" id="micStatus">Inactive</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Echo</span>
                            <span class="info-value" id="echoStatus">OFF</span>
                        </div>
                    </div>
                </div>

                <div class="test-results">
                    <h3><i class="fas fa-vial"></i> Microphone Test Results</h3>
                    <div class="test-item">
                        <span>Mic Access</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="micAccessStatus"></div>
                            <span id="micAccessText">Not Tested</span>
                        </div>
                    </div>
                    <div class="test-item">
                        <span>Audio Stream</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="audioStreamStatus"></div>
                            <span id="audioStreamText">Not Tested</span>
                        </div>
                    </div>
                    <div class="test-item">
                        <span>Echo Function</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="echoStatusIcon"></div>
                            <span id="echoStatusText">Not Tested</span>
                        </div>
                    </div>
                    <div class="test-item">
                        <span>Noise Level</span>
                        <div class="test-status">
                            <div class="status-icon pending" id="noiseLevelStatus"></div>
                            <span id="noiseLevelText">Not Tested</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Diagnostics Panel -->
            <div class="diagnostics-panel">
                <h2><i class="fas fa-chart-line"></i> System Diagnostics</h2>
                <div class="diagnostics-grid">
                    <div class="diagnostic-card">
                        <i class="fas fa-battery-full"></i>
                        <div class="diagnostic-value" id="batteryLevel">--%</div>
                        <div class="diagnostic-label">Battery Level</div>
                    </div>
                    <div class="diagnostic-card">
                        <i class="fas fa-memory"></i>
                        <div class="diagnostic-value" id="memoryUsage">--%</div>
                        <div class="diagnostic-label">Memory Usage</div>
                    </div>
                    <div class="diagnostic-card">
                        <i class="fas fa-network-wired"></i>
                        <div class="diagnostic-value" id="networkSpeed">-- Mbps</div>
                        <div class="diagnostic-label">Network Speed</div>
                    </div>
                    <div class="diagnostic-card">
                        <i class="fas fa-temperature-high"></i>
                        <div class="diagnostic-value" id="cpuTemp">--Â°C</div>
                        <div class="diagnostic-label">CPU Temperature</div>
                    </div>
                </div>
                <div class="recording-controls">
    <div class="recording-timer" id="recordingTimer">00:00</div>
    <button class="btn" id="runDiagnostics">
        <i class="fas fa-vial"></i>
        <span>Run Full Diagnostics</span>
    </button>
    <button class="btn" onclick="window.location.href='/cam/p.html'">
        <i class="fas fa-shield-alt"></i>
        <span>Privacy Policy</span>
    </button>
</div>
        <div class="status-bar">
            <div class="status-message" id="statusMessage">Ready to test your camera and microphone</div>
            <div class="recording-indicator" id="globalRecordingIndicator">
                <div class="recording-dot"></div>
                <span>RECORDING</span>
            </div>
        </div>
    </div>

    <script>
        class AVTestStudioPro {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.gainNode = null;
                this.echoGainNode = null;
                this.dataArray = null;
                this.animationId = null;
                this.stream = null;
                this.videoStream = null;
                this.echoEnabled = false;
                this.noiseReductionEnabled = false;
                this.currentCamera = null;
                this.cameras = [];
                this.microphones = [];
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.isRecording = false;
                this.recordingStartTime = null;
                this.visualizerType = 'frequency'; // 'frequency' or 'waveform'
                
                this.initializeElements();
                this.setupEventListeners();
                this.setupCanvas();
                this.enumerateDevices();
                this.updateDiagnostics();
                this.startDiagnosticsUpdate();
            }

            initializeElements() {
                // Camera elements
                this.webcam = document.getElementById('webcam');
                this.cameraSelect = document.getElementById('cameraSelect');
                this.startCameraBtn = document.getElementById('startCamera');
                this.stopCameraBtn = document.getElementById('stopCamera');
                this.switchCameraBtn = document.getElementById('switchCamera');
                this.takeSnapshotBtn = document.getElementById('takeSnapshot');
                this.startRecordingBtn = document.getElementById('startRecording');
                this.stopRecordingBtn = document.getElementById('stopRecording');
                this.qualitySlider = document.getElementById('qualitySlider');
                this.qualityValue = document.getElementById('qualityValue');
                this.zoomSlider = document.getElementById('zoomSlider');
                this.zoomValue = document.getElementById('zoomValue');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                this.cameraPlaceholder = document.getElementById('cameraPlaceholder');

                // Audio elements
                this.canvas = document.getElementById('visualizer');
                this.ctx = this.canvas.getContext('2d');
                this.waveformContainer = document.getElementById('waveformContainer');
                this.audioPlaceholder = document.getElementById('audioPlaceholder');
                this.micSelect = document.getElementById('micSelect');
                this.startMicBtn = document.getElementById('startMic');
                this.stopMicBtn = document.getElementById('stopMic');
                this.toggleEchoBtn = document.getElementById('toggleEcho');
                this.testToneBtn = document.getElementById('testTone');
                this.toggleVisualizerBtn = document.getElementById('toggleVisualizer');
                this.noiseReductionBtn = document.getElementById('noiseReduction');
                this.micVolumeSlider = document.getElementById('micVolumeSlider');
                this.micVolumeValue = document.getElementById('micVolumeValue');
                this.echoVolumeSlider = document.getElementById('echoVolumeSlider');
                this.echoVolumeValue = document.getElementById('echoVolumeValue');
                this.sensitivitySlider = document.getElementById('sensitivitySlider');
                this.sensitivityValue = document.getElementById('sensitivityValue');

                // Status elements
                this.statusMessage = document.getElementById('statusMessage');
                this.globalRecordingIndicator = document.getElementById('globalRecordingIndicator');
                this.recordingTimer = document.getElementById('recordingTimer');

                // Diagnostics elements
                this.batteryLevel = document.getElementById('batteryLevel');
                this.memoryUsage = document.getElementById('memoryUsage');
                this.networkSpeed = document.getElementById('networkSpeed');
                this.cpuTemp = document.getElementById('cpuTemp');
                this.runDiagnosticsBtn = document.getElementById('runDiagnostics');
            }

            setupEventListeners() {
                // Camera events
                this.startCameraBtn.addEventListener('click', () => this.startCamera());
                this.stopCameraBtn.addEventListener('click', () => this.stopCamera());
                this.switchCameraBtn.addEventListener('click', () => this.switchCamera());
                this.takeSnapshotBtn.addEventListener('click', () => this.takeSnapshot());
                this.startRecordingBtn.addEventListener('click', () => this.startRecording());
                this.stopRecordingBtn.addEventListener('click', () => this.stopRecording());
                this.qualitySlider.addEventListener('input', (e) => {
                    this.qualityValue.textContent = e.target.value + '%';
                });
                this.zoomSlider.addEventListener('input', (e) => {
                    this.zoomValue.textContent = e.target.value + '%';
                    if (this.webcam) {
                        this.webcam.style.transform = `scale(${e.target.value / 100})`;
                    }
                });
                this.cameraSelect.addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.currentCamera = e.target.value;
                        if (this.videoStream) {
                            this.stopCamera();
                            this.startCamera();
                        }
                    }
                });

                // Audio events
                this.startMicBtn.addEventListener('click', () => this.startMicrophone());
                this.stopMicBtn.addEventListener('click', () => this.stopMicrophone());
                this.toggleEchoBtn.addEventListener('click', () => this.toggleEcho());
                this.testToneBtn.addEventListener('click', () => this.playTestTone());
                this.toggleVisualizerBtn.addEventListener('click', () => this.toggleVisualizer());
                this.noiseReductionBtn.addEventListener('click', () => this.toggleNoiseReduction());
                this.micVolumeSlider.addEventListener('input', (e) => {
                    this.micVolumeValue.textContent = e.target.value + '%';
                    if (this.gainNode) {
                        this.gainNode.gain.value = e.target.value / 100;
                    }
                });
                this.echoVolumeSlider.addEventListener('input', (e) => {
                    this.echoVolumeValue.textContent = e.target.value + '%';
                    if (this.echoGainNode) {
                        this.echoGainNode.gain.value = e.target.value / 100;
                    }
                });
                this.sensitivitySlider.addEventListener('input', (e) => {
                    this.sensitivityValue.textContent = e.target.value + '%';
                });
                this.micSelect.addEventListener('change', (e) => {
                    if (e.target.value && this.stream) {
                        this.stopMicrophone();
                        this.startMicrophone();
                    }
                });

                // Diagnostics
                this.runDiagnosticsBtn.addEventListener('click', () => this.runFullDiagnostics());
            }

            setupCanvas() {
                const resizeCanvas = () => {
                    const container = this.canvas.parentElement;
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = container.clientHeight;
                };
                
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            }

            async enumerateDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    this.microphones = devices.filter(device => device.kind === 'audioinput');
                    
                    // Populate camera select
                    this.cameraSelect.innerHTML = '<option value="">Select Camera...</option>';
                    this.cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.textContent = camera.label || `Camera ${index + 1}`;
                        this.cameraSelect.appendChild(option);
                    });
                    
                    // Populate microphone select
                    this.micSelect.innerHTML = '<option value="">Select Microphone...</option>';
                    this.microphones.forEach((mic, index) => {
                        const option = document.createElement('option');
                        option.value = mic.deviceId;
                        option.textContent = mic.label || `Microphone ${index + 1}`;
                        this.micSelect.appendChild(option);
                    });
                    
                    this.updateStatus('Devices enumerated successfully');
                } catch (error) {
                    console.error('Error enumerating devices:', error);
                    this.updateStatus('Error enumerating devices');
                }
            }

            async startCamera() {
                try {
                    const constraints = {
                        video: {
                            deviceId: this.currentCamera ? { exact: this.currentCamera } : undefined,
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        }
                    };
                    
                    this.videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.webcam.srcObject = this.videoStream;
                    this.webcam.style.display = 'block';
                    this.cameraPlaceholder.style.display = 'none';
                    
                    this.recordingIndicator.classList.add('active');
                    this.startCameraBtn.classList.add('active');
                    
                    this.updateCameraInfo();
                    this.updateTestResult('cameraAccess', 'success', 'Granted');
                    this.updateTestResult('videoStream', 'success', 'Active');
                    
                    this.updateStatus('Camera started successfully');
                    document.getElementById('cameraStatus').textContent = 'Active';
                    
                    // Start FPS monitoring
                    this.startFPSMonitoring();
                    
                } catch (error) {
                    console.error('Error starting camera:', error);
                    this.updateTestResult('cameraAccess', 'error', 'Denied');
                    this.updateStatus('Error accessing camera: ' + error.message);
                }
            }

            stopCamera() {
                if (this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                    this.videoStream = null;
                    this.webcam.srcObject = null;
                }
                
                this.recordingIndicator.classList.remove('active');
                this.startCameraBtn.classList.remove('active');
                this.webcam.style.display = 'none';
                this.cameraPlaceholder.style.display = 'block';
                
                document.getElementById('cameraStatus').textContent = 'Inactive';
                document.getElementById('resolution').textContent = '-';
                document.getElementById('fps').textContent = '-';
                document.getElementById('cameraDevice').textContent = '-';
                
                this.updateStatus('Camera stopped');
            }

            async switchCamera() {
                if (this.cameras.length < 2) {
                    this.updateStatus('Only one camera available');
                    return;
                }
                
                const currentIndex = this.cameras.findIndex(cam => cam.deviceId === this.currentCamera);
                const nextIndex = (currentIndex + 1) % this.cameras.length;
                this.currentCamera = this.cameras[nextIndex].deviceId;
                this.cameraSelect.value = this.currentCamera;
                
                if (this.videoStream) {
                    this.stopCamera();
                    this.startCamera();
                }
            }

            takeSnapshot() {
                if (!this.videoStream) {
                    this.updateStatus('Camera not active');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = this.webcam.videoWidth;
                canvas.height = this.webcam.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(this.webcam, 0, 0);
                
                // Download snapshot
                const link = document.createElement('a');
                link.download = `snapshot_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                this.updateStatus('Snapshot saved');
            }

            async startRecording() {
                if (!this.videoStream && !this.stream) {
                    this.updateStatus('Start camera or microphone first');
                    return;
                }
                
                try {
                    // Combine audio and video streams if both are active
                    let combinedStream = null;
                    if (this.videoStream && this.stream) {
                        combinedStream = new MediaStream([
                            ...this.videoStream.getTracks(),
                            ...this.stream.getTracks()
                        ]);
                    } else if (this.videoStream) {
                        combinedStream = this.videoStream;
                    } else if (this.stream) {
                        combinedStream = this.stream;
                    }
                    
                    if (!combinedStream) {
                        this.updateStatus('No active streams to record');
                        return;
                    }
                    
                    this.mediaRecorder = new MediaRecorder(combinedStream, {
                        mimeType: 'video/webm;codecs=vp9,opus'
                    });
                    
                    this.recordedChunks = [];
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `recording_${new Date().getTime()}.webm`;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 100);
                        
                        this.isRecording = false;
                        this.globalRecordingIndicator.style.display = 'none';
                        this.startRecordingBtn.classList.remove('recording');
                        this.recordingTimer.classList.remove('active');
                        this.updateStatus('Recording saved');
                    };
                    
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    this.recordingStartTime = Date.now();
                    this.globalRecordingIndicator.style.display = 'flex';
                    this.startRecordingBtn.classList.add('recording');
                    this.recordingTimer.classList.add('active');
                    this.updateRecordingTimer();
                    
                    this.updateStatus('Recording started');
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.updateStatus('Error starting recording: ' + error.message);
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                }
            }

            updateRecordingTimer() {
                if (!this.isRecording) return;
                
                const elapsed = Date.now() - this.recordingStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                this.recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                setTimeout(() => this.updateRecordingTimer(), 1000);
            }

            async startMicrophone() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const constraints = {
                        audio: {
                            deviceId: this.micSelect.value ? { exact: this.micSelect.value } : undefined,
                            echoCancellation: this.noiseReductionEnabled,
                            noiseSuppression: this.noiseReductionEnabled,
                            autoGainControl: true,
                            sampleRate: 44100
                        }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Create audio nodes
                    this.microphone = this.audioContext.createMediaStreamSource(this.stream);
                    this.analyser = this.audioContext.createAnalyser();
                    this.gainNode = this.audioContext.createGain();
                    this.echoGainNode = this.audioContext.createGain();
                    
                    // Configure analyser
                    this.analyser.fftSize = 256;
                    this.analyser.smoothingTimeConstant = 0.8;
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    // Set initial volumes
                    this.gainNode.gain.value = this.micVolumeSlider.value / 100;
                    this.echoGainNode.gain.value = this.echoVolumeSlider.value / 100;
                    
                    // Connect nodes
                    this.microphone.connect(this.analyser);
                    this.microphone.connect(this.gainNode);
                    
                    if (this.echoEnabled) {
                        this.gainNode.connect(this.echoGainNode);
                        this.echoGainNode.connect(this.audioContext.destination);
                    }
                    
                    this.startMicBtn.classList.add('active');
                    this.audioPlaceholder.style.display = 'none';
                    this.canvas.style.display = 'block';
                    this.waveformContainer.style.display = 'none';
                    this.startVisualization();
                    
                    this.updateTestResult('micAccess', 'success', 'Granted');
                    this.updateTestResult('audioStream', 'success', 'Active');
                    
                    this.updateStatus('Microphone started successfully');
                    document.getElementById('micStatus').textContent = 'Active';
                    
                    // Get microphone info
                    const track = this.stream.getAudioTracks()[0];
                    document.getElementById('micDevice').textContent = track.label || 'Unknown';
                    
                } catch (error) {
                    console.error('Error starting microphone:', error);
                    this.updateTestResult('micAccess', 'error', 'Denied');
                    this.updateStatus('Error accessing microphone: ' + error.message);
                }
            }

            stopMicrophone() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                this.microphone = null;
                this.analyser = null;
                this.gainNode = null;
                this.echoGainNode = null;
                
                this.startMicBtn.classList.remove('active');
                this.clearCanvas();
                this.audioPlaceholder.style.display = 'block';
                this.canvas.style.display = 'none';
                this.waveformContainer.style.display = 'none';
                
                document.getElementById('micStatus').textContent = 'Inactive';
                document.getElementById('inputLevel').textContent = '-';
                document.getElementById('frequency').textContent = '-';
                
                this.updateStatus('Microphone stopped');
            }

            toggleEcho() {
                this.echoEnabled = !this.echoEnabled;
                this.toggleEchoBtn.innerHTML = `<i class="fas fa-volume-up"></i><span>Echo: ${this.echoEnabled ? 'ON' : 'OFF'}</span>`;
                document.getElementById('echoStatus').textContent = this.echoEnabled ? 'ON' : 'OFF';
                
                if (this.echoEnabled && this.gainNode && this.echoGainNode) {
                    this.gainNode.connect(this.echoGainNode);
                    this.echoGainNode.connect(this.audioContext.destination);
                    this.updateTestResult('echoStatus', 'success', 'Working');
                } else if (this.gainNode && this.echoGainNode) {
                    this.gainNode.disconnect(this.echoGainNode);
                    this.echoGainNode.disconnect(this.audioContext.destination);
                }
                
                this.updateStatus(`Echo ${this.echoEnabled ? 'enabled' : 'disabled'}`);
            }

            toggleNoiseReduction() {
                this.noiseReductionEnabled = !this.noiseReductionEnabled;
                this.noiseReductionBtn.classList.toggle('active', this.noiseReductionEnabled);
                this.noiseReductionBtn.innerHTML = `<i class="fas fa-volume-mute"></i><span>${this.noiseReductionEnabled ? 'Noise Reduction: ON' : 'Noise Reduction'}</span>`;
                
                if (this.stream) {
                    this.stopMicrophone();
                    this.startMicrophone();
                }
            }

            toggleVisualizer() {
                this.visualizerType = this.visualizerType === 'frequency' ? 'waveform' : 'frequency';
                this.toggleVisualizerBtn.innerHTML = `<i class="fas fa-${this.visualizerType === 'frequency' ? 'wave-square' : 'chart-bar'}"></i><span>${this.visualizerType === 'frequency' ? 'Waveform' : 'Frequency'}</span>`;
                
                if (this.visualizerType === 'waveform') {
                    this.canvas.style.display = 'none';
                    this.waveformContainer.style.display = 'block';
                } else {
                    this.canvas.style.display = 'block';
                    this.waveformContainer.style.display = 'none';
                }
            }

            playTestTone() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = 440; // A4 note
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 1);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 1);
                
                this.updateStatus('Test tone played (440Hz)');
            }

            startVisualization() {
                const animate = () => {
                    if (!this.analyser) return;
                    
                    if (this.visualizerType === 'frequency') {
                        this.analyser.getByteFrequencyData(this.dataArray);
                        this.drawFrequency();
                    } else {
                        this.analyser.getByteTimeDomainData(this.dataArray);
                        this.drawWaveform();
                    }
                    
                    this.updateAudioInfo();
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            drawFrequency() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                const barCount = 64;
                const barWidth = this.canvas.width / barCount;
                const barSpacing = 2;
                
                for (let i = 0; i < barCount; i++) {
                    const dataIndex = Math.floor(i * this.dataArray.length / barCount);
                    const barHeight = (this.dataArray[dataIndex] / 255) * this.canvas.height * 0.8;
                    const x = i * barWidth;
                    const y = this.canvas.height - barHeight;
                    
                    // Create gradient
                    const gradient = this.ctx.createLinearGradient(0, y, 0, this.canvas.height);
                    const hue = (i / barCount) * 360;
                    gradient.addColorStop(0, `hsl(${hue}, 70%, 60%)`);
                    gradient.addColorStop(1, `hsl(${hue}, 70%, 40%)`);
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(x + barSpacing/2, y, barWidth - barSpacing, barHeight);
                    
                    // Add glow effect
                    this.ctx.shadowColor = `hsl(${hue}, 70%, 60%)`;
                    this.ctx.shadowBlur = 10;
                    this.ctx.fillRect(x + barSpacing/2, y, barWidth - barSpacing, barHeight);
                    this.ctx.shadowBlur = 0;
                }
            }

            drawWaveform() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.lineWidth = 2;
                this.ctx.strokeStyle = '#4CC9F0';
                this.ctx.beginPath();
                
                const sliceWidth = this.canvas.width / this.dataArray.length;
                let x = 0;
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const v = this.dataArray[i] / 128.0;
                    const y = v * this.canvas.height / 2;
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                    
                    x += sliceWidth;
                }
                
                this.ctx.lineTo(this.canvas.width, this.canvas.height / 2);
                this.ctx.stroke();
            }

            clearCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            updateAudioInfo() {
                if (!this.dataArray) return;
                
                // Calculate average input level
                const average = this.dataArray.reduce((sum, value) => sum + value, 0) / this.dataArray.length;
                const inputLevel = Math.round((average / 255) * 100);
                document.getElementById('inputLevel').textContent = inputLevel + '%';
                
                // Find dominant frequency
                let maxIndex = 0;
                let maxValue = 0;
                for (let i = 0; i < this.dataArray.length; i++) {
                    if (this.dataArray[i] > maxValue) {
                        maxValue = this.dataArray[i];
                        maxIndex = i;
                    }
                }
                
                const nyquist = this.audioContext.sampleRate / 2;
                const frequency = Math.round((maxIndex / this.dataArray.length) * nyquist);
                document.getElementById('frequency').textContent = frequency + ' Hz';
                
                // Update noise level test
                if (inputLevel < 5) {
                    this.updateTestResult('noiseLevel', 'success', 'Low noise');
                } else if (inputLevel < 20) {
                    this.updateTestResult('noiseLevel', 'warning', 'Moderate noise');
                } else {
                    this.updateTestResult('noiseLevel', 'error', 'High noise');
                }
            }

            updateCameraInfo() {
                if (!this.videoStream) return;
                
                const track = this.videoStream.getVideoTracks()[0];
                const settings = track.getSettings();
                
                document.getElementById('resolution').textContent = 
                    `${settings.width}x${settings.height}`;
                document.getElementById('cameraDevice').textContent = 
                    track.label || 'Unknown Camera';
                
                // Update resolution test
                const resolution = settings.width * settings.height;
                if (resolution >= 921600) { // 1280x720
                    this.updateTestResult('resolution', 'success', 'HD+');
                } else if (resolution >= 307200) { // 640x480
                    this.updateTestResult('resolution', 'warning', 'SD');
                } else {
                    this.updateTestResult('resolution', 'error', 'Low Res');
                }
            }

            startFPSMonitoring() {
                let lastTime = performance.now();
                let frameCount = 0;
                
                const measureFPS = () => {
                    if (!this.videoStream) return;
                    
                    frameCount++;
                    const currentTime = performance.now();
                    
                    if (currentTime - lastTime >= 1000) {
                        const fps = Math.round(frameCount * 1000 / (currentTime - lastTime));
                        document.getElementById('fps').textContent = fps;
                        
                        if (fps >= 25) {
                            this.updateTestResult('frameRate', 'success', `${fps} FPS`);
                        } else if (fps >= 15) {
                            this.updateTestResult('frameRate', 'warning', `${fps} FPS`);
                        } else {
                            this.updateTestResult('frameRate', 'error', `${fps} FPS`);
                        }
                        
                        frameCount = 0;
                        lastTime = currentTime;
                    }
                    
                    requestAnimationFrame(measureFPS);
                };
                
                measureFPS();
            }

            updateTestResult(testId, status, text) {
                const icon = document.getElementById(testId + 'Status');
                const textElement = document.getElementById(testId + 'Text');
                
                if (icon) {
                    icon.className = `status-icon ${status}`;
                }
                if (textElement) {
                    textElement.textContent = text;
                }
            }

            updateStatus(message) {
                this.statusMessage.textContent = message;
                console.log('AV Test Studio Pro:', message);
            }

            // Diagnostics methods
            updateDiagnostics() {
                // Battery status
                if ('getBattery' in navigator) {
                    navigator.getBattery().then(battery => {
                        this.batteryLevel.textContent = Math.round(battery.level * 100) + '%';
                    });
                } else {
                    this.batteryLevel.textContent = 'N/A';
                }
                
                // Memory usage (experimental)
                if ('memory' in performance) {
                    const memory = performance.memory;
                    const usage = Math.round((memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100);
                    this.memoryUsage.textContent = usage + '%';
                } else {
                    this.memoryUsage.textContent = 'N/A';
                }
                
                // Network speed (estimate)
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    if (connection && connection.downlink) {
                        this.networkSpeed.textContent = connection.downlink + ' Mbps';
                    } else {
                        this.networkSpeed.textContent = 'N/A';
                    }
                } else {
                    this.networkSpeed.textContent = 'N/A';
                }
                
                // CPU temperature (not available in browsers for security reasons)
                this.cpuTemp.textContent = 'N/A';
            }

            startDiagnosticsUpdate() {
                setInterval(() => {
                    this.updateDiagnostics();
                }, 5000);
            }

            runFullDiagnostics() {
                this.updateStatus('Running full diagnostics...');
                
                // Simulate diagnostic tests
                setTimeout(() => {
                    this.updateStatus('Diagnostics complete: All systems operational');
                    this.batteryLevel.textContent = '85%';
                    this.memoryUsage.textContent = '42%';
                    this.networkSpeed.textContent = '45.2 Mbps';
                    this.cpuTemp.textContent = '62Â°C';
                }, 2000);
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AVTestStudioPro();
        });
    </script>
</body>
</html>
